{% extends "layout.html" %}
{% load static %}
{% block content %}
<div class="page">

{% if not game.date_started %}
  <p>
    Encourage others to join: <input value="{{base_url}}{% url 'matthews:lobby' game.id %}">
  </p>

  <ul>
    {% for player in players %}
      <li>
        {{player.name}}
        {% if my_player.id == player.id %}
        (you)
        {% endif %}
      </li>
    {% endfor %}
  </ul>

  {% if my_player.id == players.0.id  %}
  <form action="{% url 'matthews:start' %}" method="POST">
    {% csrf_token %}
    <input type="submit" value="Start game" class="btn btn-primary">
  </form>
  {% else %}
  {{players.0.name}} is in charge of starting game
  {% endif %}

{% else %}

  {% if mafia_win is None %}
  <h2><span style="opacity: 0.3">Round {{round|add:'1'}}</span>  {{round|divisibleby:'2'|yesno:"Daytime discussions,Nightime creeping"}}</h2>
  {% else %}
  <h2>Performance review</h2>
  {% endif %}

  <input id="update_opener" type="checkbox" class="d-none" {{my_action|yesno:',checked'}}>
  <label class="update_panel" for="update_opener">
  {% if round == 0 %}
    <h2>Intro to game...</h2>
  {% elif mafia_win is not None %}
    <h2>In conclusion...</h2>
    <p>
    {% if mafia_win %}
      With {{deaths.0}}'s last breath they gasped "you'll never divide us" - little
      did they know it was already too late.
    {% else %}
      With {{deaths.0}}'s demise the dark cloud lifted from the people. The rot had been stopped and
      the survivors lived in peace and harmony. For now...
    {% endif %}
    </p>

  {% else %}
    <h2>{{round|divisibleby:'2'|yesno:"Last night,Earlier today"}}...</h2>
    {% if round|divisibleby:'2' %}
      {% for dead in deaths %}
      {% if my_player.id == dead.id %}
      <p>
        You died a painful death!
        <i>
          You can not speak to other players until the end of the game.
          You may make ghostly noises at purely random times.
          Each night you will get the chance to haunt the dreams of those who wronged you
          and the community that couldn't keep you safe.
        </i>
      </p>
      {% endif %}
      <p>
        A horrible incident at the Bakery left {{dead}} fighting for their life. Police found the body with a
        spatula stuck into its collarbone and it had lost a lot of blood. Our thoughts and prayers are
        with the family at this difficult time.
      </p>
      {% empty %}
      <p>
        Everyone survived.
      </p>
      {% endfor %}
    {% else %}
      <p>
        {% regroup votes by done_to as votes_for %}
        {% for target, votes in votes_for %}
        {% for vote in votes %}
          {% if forloop.last and not forloop.first %}and{% endif %}
          {{vote.done_by}}{% if forloop.revcounter > 2 %},{% endif %}
        {% endfor %} voted for {{target|default_if_none:'no lynching'}}<br>
        {% endfor %}
      </p>
      {% for dead in deaths %}
      <p>
        The people have spoken and decided to put {{dead}} to death by hanging.
      </p>
      {% empty %}
      <p>
        We thought better of our lynching instincts and everyone made it to bed safely.
      </p>
      {% endfor %}
    {% endif %}

    {% if suspect %}
    <p class="secret_note">
      Psst... {{suspect}} is {% if suspect.character_id == MAFIA_ID %}in the mafia{% else %}one of the good guys{% endif %} - ‚ù§ your favourite snitch x
    </p>
    {% endif %}

  {% endif %}
  </label>

  <form class="vote-form {% if mafia_win is not None %}game_over{% endif %}" action="{% url 'matthews:target' %}" method="POST">
  {% csrf_token %}
    {% for player in players %}
      <input type="radio" name="target" id="player_{{player.id}}" value="{{player.id}}" {%if my_action or mafia_win is not None%}disabled {%if my_action.done_to == player %}checked {%endif%}{%endif%}>
      <label class="{% if my_player.character_id == MAFIA_ID and player.character_id == MAFIA_ID %}mark_bad{% endif%}
                    {{player.died_in_round|yesno:'mark_dead,mark_dead,'}}
                    "
             for="player_{{player.id}}">
        <h2>
          {{player.name}}
          {% if debug and my_player.id != player.id %}
          <a class="play_as" href="{% url 'matthews:game' %}?play_as_id={{player.id}}" title="{{player.character.name}}">@</a>
          {% endif %}
        </h2>
        <div class="portrait"></div>
        <p class="info">
        {% if my_player.id == player.id %}
        <span>You, {{my_player.character}}</span>
        {% elif my_player.character_id == MAFIA_ID and player.character_id == MAFIA_ID %}
        <span>{{player.character}}</span>
        {% else %}
        <span>&nbsp;</span>
        {% endif %}
        <br>
        {% if my_player.id == player.id and my_action %}
        <i>chose {% if my_action.done_to %}{{my_action.done_to.name}}{% else %}No one {% endif %}</i>
        {% elif player.has_acted %}
        <i>has acted</i>
        {% else %}
        <i>&nbsp;</i>
        {% endif %}
        </p>

        {% if not my_action %}
        <input type="submit" value="{% include 'matthews/_action_name.html' with player=my_player %}" class="btn btn-primary">
        {% endif %}
      </label>
      <div class="player_results">
      {% if mafia_win is not None %}
        <h4>
          {{player.character}},
          {% if player.died_in_round %}
            {{player.died_in_round|divisibleby:'2'|yesno:"lynched, murdered"}} in round {{player.died_in_round}}
          {% else %}
            survived
          {% endif %}
           fav:{{player.favourite_person}}
        </h4>
        <p>
          Killed {{player.killed_bad|add:player.lynched_bad}} bad guy{{player.killed_bad|add:player.lynched_bad|pluralize}} and
            {{player.killed_good|add:player.lynched_good}} good guy{{player.killed_good|add:player.lynched_good|pluralize}}<br>
          {% if player.character_id == 1 %}
            Effective assisination: {{player.successful_kill_pc|floatformat:0}}%<br>
            {{player.killed_doctor|yesno:"Killed,Failed to kill"}} doctor
            {% if player.killed_doctor != player.killed_detective %}but{% else %}and{% endif %}
            {{player.killed_detective|yesno:"killed,failed to kill"}} detective<br>
          {% elif player.character_id == 2 %}
            Suspicions were accurate {{player.suspected_bad_pc|floatformat:0}}% of the time<br>
          {% elif player.character_id == 3 %}
            Saved {{player.lives_saved}} live{{player.lives_saved|pluralize}}<br>
          {% elif player.character_id == 4 %}
            Mafia discovered: {{player.mafia_found}}<br>
          {% endif %}
          {% if player.character_id != MAFIA_ID %}
            Was attacked {{player.mafia_target}} time{{player.mafia_target|pluralize}}
          {% endif %}
          {% if player.character_id == MAFIA_ID and player.mafia_target %}
            Was attacked by fellow mafia members {{player.mafia_target}} time{{player.mafia_target|pluralize}}
          {% endif %}
        </p>
      {% endif %}
      </div>
    {% endfor %}
    <input type="radio" name="target" id="player_0" value="0" {%if my_action or mafia_win is not None%}disabled {%if my_action and my_action.done_to is None %}checked {%endif%}{%endif%}>
    <label for="player_0">
      {% if not my_action %}
      {% endif %}
      <h2>No one</h2>

      {% if not my_action %}
      <input type="submit" value="{% include 'matthews/_action_name.html' with player=my_player %}" class="btn btn-primary">
      {% endif %}
    </label>
    {% if mafia_win is not None %}
      <div class="player_results">
        <h4>The choice to do nothing, survived!</h4>
        <p>
          Killed: no bad guys, no good guys - super nice dude<br>
          Lynched 22 times and did nothing wrong<br>
          Saved by the doctor, who is an idiot<br>
        </p>
      </div>
    {% endif %}
  <br>
  {% if my_action %}
    <a class="btn btn-primary" href="{% url 'matthews:game' %}">refresh list</a>
  {% endif %}
  </form>



  {% if debug %}
  <p class="mt-5">
    <a class="btn btn-danger float-right" href="{% url 'matthews:cast-all' %}">Cast all remaining votes</a>
  </p>
  {% endif %}

{% endif %}

</div>



<style>
body { background-color: #5f5c69;}
.page {
  position: relative;
  max-width: 800px;
  padding: 2em 2em 10em;
  margin: 2em auto 20em;
  background-color: white;
}

.update_panel {
  z-index: 3;
  position: absolute;
  width: 17em;
  height: 3em;
  border-radius: 0.2em;
  top: -1em;
  right: -2em;
  overflow: hidden;
  background-color: #fec;
  box-shadow: 3px 3px 6px rgba(0,0,0,0.3);
  transform: rotate(10deg);
  transition: 0.1s;
  padding-left: 2em;
}
[type=checkbox]:checked + .update_panel{
  display: block;
  top: 2em;
  right: 2em;
  width: 85%;
  padding: 2em;
  margin: 5%;
  min-height: 20em;
  transform: rotate(-1deg);
}
.secret_note {
  font-family: cursive;
}

.mark_dead { filter: grayscale(1); opacity: 0.5;}
.win_text{
  font-size: 6em;
  color: red;
}
.play_as {
  position: absolute;
  right: 0;
  bottom: 0;
  display: none;
}
label:hover .play_as { display: block; }

.vote-form {text-align:center;}

[type=radio] {display:none;}
label {
  display:inline-block;
  height: 172px;
  margin: 1em 1em 4em;
  position: relative;
  cursor: pointer;
  vertical-align: top;
  transition: 0.1s;
  background-color: #f2e9e4;
}
label > h2{
  overflow: hidden;
  padding: 0.1em;
  margin-bottom: 0em;
}

[type=radio]:disabled + label { cursor: default; }
[type=radio]:checked + label
{
  transform: scale(1.1);
  box-shadow: 2px 3px 4px rgba(0,0,0,0.2);
  background-color: #007bff;
}
[type=radio]:checked + label h2 { color: white; }

.portrait {
  width: 115px;
  height: 123px;
  background: url('{% static 'matthews/images/avatar_test.jpg' %}') top left no-repeat #f2e9e4;
  background-size: 350px 360px;
  margin: 0em auto 0.5em;

}
label:nth-child(3) .portrait { background-position: top left; }
label:nth-child(6) .portrait { background-position: top center; }
label:nth-child(9) .portrait { background-position: top right; }
label:nth-child(12) .portrait { background-position: center left; }
label:nth-child(15) .portrait { background-position: center center; }
label:nth-child(18) .portrait { background-position: center right; }
label:nth-child(21) .portrait { background-position: bottom left; }
label:nth-child(24) .portrait { background-position: bottom center; }
label:nth-child(27) .portrait { background-position: bottom right; }
[for=player_0] .portrait { background-image: none;}

.vote-form [type=submit] {
  position: absolute;
  top: 102%;
  width: 120%;
  left: -10%;
  display: none;
  z-index: 2;
}
.vote-form [type=radio]:checked + label [type=submit] {display: block;}

.player_results {
  width: 65%;
  margin: 1em;
  text-align: left;
  padding: 1em;
  display: none;
}

.game_over .player_results {
  display: inline-block;
}

</style>

{% endblock %}


